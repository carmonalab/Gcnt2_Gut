---
title: "Analysis of GCNT2 Expression Profile"
author: "A. Mihaylov <aleksandar.mihaylov@epfl.ch>"
---

# Preparing Finely Annotated Dataset

## Downloading Finely Annotated Dataset

```{r downloading_processed_dataset}
library(dplyr)
source("Rutils/functions.R")

ds_name <- "SalasA_2023_GSE214695"
home.path <- file.path(getwd(), ds_name)
output_data_path <- file.path(home.path, "output")

size <- "whole" # "light" or "whole"

# cmc stands for colonic mucosa cells
cmc <- readRDS(file.path(output_data_path, paste0(ds_name, 
                                                  sprintf("_finely_annotated_%s.rds", size))))
```

## Extracting GCNT2 Counts 

```{r extracting_counts}
counts <- Seurat::GetAssayData(cmc, assay = "RNA", slot = "data")
gcnt2_counts <- counts["GCNT2", ]
cmc$GCNT2 <- gcnt2_counts
```

# Initial Analysis per Cell Type

## Initial Statistical Tests

```{r in_stat_tests}
gcnt2.cell_type.expression <- cmc@meta.data[, c("manual_annotation", "GCNT2")]

# Anova table across cell types
gcnt2.aov.model <- aov(gcnt2.cell_type.expression$GCNT2 ~ gcnt2.cell_type.expression$manual_annotation)
print(as.data.frame(summary(gcnt2.aov.model)[[1]]))

# Post-hoc Tukey HSD test for all pairs of cell types
gcnt2.tukey.results <- TukeyHSD(gcnt2.aov.model)
print(as.data.frame(gcnt2.tukey.results[[1]]))

# Wilcoxon test for all pairs of cell types
gcnt2.wilcox.results <- multiple.wilcox.tests(gcnt2.cell_type.expression, 
                                              "manual_annotation", 
                                              "GCNT2") 
print(gcnt2.wilcox.results)

# Two-sample t-test for all pairs of cell types
gcnt2.t_test.results <- pairwise.t.test(gcnt2.cell_type.expression$GCNT2,
                                        gcnt2.cell_type.expression$manual_annotation, 
                                        alternative = "two.sided", 
                                        p.adjust.method = "fdr")
print(as.data.frame(gcnt2.t_test.results$p.value))
```

## Initial Diagnostic Plots

```{r in_diganostic_plots}
# Violin plots of GCNT2 expression across cell types
Seurat::VlnPlot(cmc, features = "GCNT2", group.by = "manual_annotation") + 
  ggplot2::ggtitle("Violin Plots of GCNT2 Expression across Cell Types")

# Box plots of GCNT2 expression across cell types
ggplot2::ggplot(gcnt2.cell_type.expression, 
                ggplot2::aes(x = manual_annotation, y = GCNT2)) + 
  ggplot2::geom_boxplot(fill="slateblue", alpha=0.2) + 
  ggplot2::xlab("Cell Type") +
  ggplot2::ylab("GCNT2 Expression") +
  ggplot2::ggtitle("Boxplot of GCNT2 Expression across Cell Types")

# Ridge plots of GCNT2 expression across cell types
Seurat::RidgePlot(cmc, features = "GCNT2", group.by = "manual_annotation") +
  ggplot2::ggtitle("Ridge Plot of GCNT2 Expression across Cell Types")

# Feature plot of GCNT2 on Umap reduction
Seurat::FeaturePlot(cmc, features = "GCNT2") +
  ggplot2::ggtitle("Feature Plot of GCNT2 Expression across Cell Types")
```

Clearly, most cells, independent of their type, do not express GCNT2. Therefore, for downstream analyses, let us focus solely on the cells which do express GCNT2.

```{r subsetting_cells}
filtered_cmc <- subset(cmc, subset = GCNT2 > 0)
cat("Number of cells left in Seurat object:", length(Seurat::Cells(filtered_cmc)))
```

# Analysis per Cell Type 

## Statistical Tests

```{r stat_tests_per_cell_type}
gcnt2.cell_type.expression <- filtered_cmc@meta.data[, c("manual_annotation", "GCNT2")]

# Anova table across cell types
gcnt2.aov.model <- aov(gcnt2.cell_type.expression$GCNT2 ~ gcnt2.cell_type.expression$manual_annotation)
print(as.data.frame(summary(gcnt2.aov.model)[[1]]))

# Post-hoc Tukey HSD test for all pairs of cell types
gcnt2.tukey.results <- TukeyHSD(gcnt2.aov.model)
print(as.data.frame(gcnt2.tukey.results[[1]]))

# Wilcoxon test for all pairs of cell types
gcnt2.wilcox.results <- multiple.wilcox.tests(gcnt2.cell_type.expression, 
                                              "manual_annotation", 
                                              "GCNT2") 
print(gcnt2.wilcox.results)

# Two-sample t-test for all pairs of cell types
gcnt2.t_test.results <- pairwise.t.test(gcnt2.cell_type.expression$GCNT2,
                                        gcnt2.cell_type.expression$manual_annotation, 
                                        alternative = "two.sided", 
                                        p.adjust.method = "fdr")
print(as.data.frame(gcnt2.t_test.results$p.value))
```

## Diagnostic Plots

```{r plots_per_cell_type}
# Violin plots of GCNT2 expression across cell types
Seurat::VlnPlot(filtered_cmc, "GCNT2", group.by = "manual_annotation") +
  ggplot2::ggtitle("Violin Plots of GCNT2 Expression across Cell Types Omitting GCNT2 Non-expressing Cells") 

# Box plots of GCNT2 expression across cell types
ggplot2::ggplot(gcnt2.cell_type.expression, 
                ggplot2::aes(x = manual_annotation, y = GCNT2)) + 
  ggplot2::geom_boxplot(fill="slateblue", alpha=0.2) + 
  ggplot2::xlab("Cell Type") +
  ggplot2::ylab("GCNT2 Expression") +
  ggplot2::ggtitle("Boxplot of GCNT2 Expression across Cell Types Omitting GCNT2 Non-expressing Cells")

# Ridge plots of GCNT2 expression across cell types
Seurat::RidgePlot(filtered_cmc, features = "GCNT2", group.by = "manual_annotation") +
  ggplot2::ggtitle("Ridge Plot of GCNT2 Expression across Cell Types Omitting GCNT2 Non-expressing Cells")
```

## Significance Plots

In this sub-section, we combine both the diagnostic plots and the test results that we obtained into significance plots. In these plots, one can visualize GCNT2 expression per cell type, and observe the statistical difference in GCNT2 expression between cell types. 

*Significance levels*

| P-value  | Legend  |
|----------|---------|
| > 0.05   | Nothing |
| ≤ 0.05   | *       |
| ≤ 0.01   | **      |
| ≤ 0.001  | ***     |
| ≤ 0.0001 | ****    |



```{r significance_plots_per_cell_type}
signif.plot(gcnt2.cell_type.expression, x = "manual_annotation", y = "GCNT2", 
            plot_type = "Violin", test = "Wilcox",
            plot_title = "GCNT2 Expression vs. Cell Type Omitting GCNT2 Non-expressing Cells, Wilcoxon Test")

signif.plot(gcnt2.cell_type.expression, x = "manual_annotation", y = "GCNT2", 
            plot_type = "Boxplot", test = "T-test",
            plot_title = "GCNT2 Expression vs. Cell Type Omitting GCNT2 Non-expressing Cells, T-Test")
```

# Analysis per Condition

## Statistical Tests

```{r stat_tests_per_condition}
# All Cells Considered

# Anova table across gut conditions
gcnt2.condition.expression <- cmc@meta.data[, c("Treatment", "GCNT2")]
gcnt2.aov.model <- aov(gcnt2.condition.expression$GCNT2 ~ gcnt2.condition.expression$Treatment)
print(as.data.frame(summary(gcnt2.aov.model)[[1]]))

# Post-hoc Tukey HSD test for all pairs of gut conditions
gcnt2.tukey.results <- TukeyHSD(gcnt2.aov.model)
print(as.data.frame(gcnt2.tukey.results[[1]]))

# Wilcoxon test for all pairs of gut conditions
gcnt2.wilcox.results <- multiple.wilcox.tests(gcnt2.condition.expression, 
                                              "Treatment", 
                                              "GCNT2") 
print(gcnt2.wilcox.results)

# Two-sample t-test for all pairs of gut conditions
gcnt2.t_test.results <- pairwise.t.test(gcnt2.condition.expression$GCNT2,
                                        gcnt2.condition.expression$Treatment, 
                                        alternative = "two.sided", 
                                        p.adjust.method = "fdr")
print(as.data.frame(gcnt2.t_test.results$p.value))
# --------------------------------------------------------------------------------------------------
# Only GCNT2 Expressing Cells Considered

# Anova table across gut conditions
gcnt2.condition.expression <- filtered_cmc@meta.data[, c("Treatment", "GCNT2")]
gcnt2.aov.model <- aov(gcnt2.condition.expression$GCNT2 ~ gcnt2.condition.expression$Treatment)
print(as.data.frame(summary(gcnt2.aov.model)[[1]]))

# Post-hoc Tukey HSD test for all pairs of gut conditions
gcnt2.tukey.results <- TukeyHSD(gcnt2.aov.model)
print(as.data.frame(gcnt2.tukey.results[[1]]))

# Wilcoxon test for all pairs of gut conditions
gcnt2.wilcox.results <- multiple.wilcox.tests(gcnt2.condition.expression, 
                                              "Treatment", 
                                              "GCNT2") 
print(gcnt2.wilcox.results)

# Two-sample t-test for all pairs of gut conditions
gcnt2.t_test.results <- pairwise.t.test(gcnt2.condition.expression$GCNT2,
                                        gcnt2.condition.expression$Treatment, 
                                        alternative = "two.sided", 
                                        p.adjust.method = "fdr")
print(as.data.frame(gcnt2.t_test.results$p.value))
```

## Diagnostic Plots

```{r plots_per_condition}
# Violin plots of GCNT2 expression across gut conditions
Seurat::VlnPlot(filtered_cmc, "GCNT2", group.by = "Treatment") +
  ggplot2::ggtitle("Violin Plots of GCNT2 Expression across Conditions Omitting GCNT2 Non-expressing Cells") 

# Box plots plots of GCNT2 expression across gut conditions
ggplot2::ggplot(gcnt2.condition.expression, 
                ggplot2::aes(x = Treatment, y = GCNT2)) + 
  ggplot2::geom_boxplot(fill="slateblue", alpha=0.2) + 
  ggplot2::xlab("Condition") +
  ggplot2::ylab("GCNT2 Expression") +
  ggplot2::ggtitle("Boxplot of GCNT2 Expression across Conditions Omitting GCNT2 Non-expressing Cells")

# Ridge plots of GCNT2 expression across gut conditions
Seurat::RidgePlot(filtered_cmc, features = "GCNT2", group.by = "Treatment") +
  ggplot2::ggtitle("Ridge Plot of GCNT2 Expression across Conditions Omitting GCNT2 Non-expressing Cells")
```

## Significance Plots

In this sub-section, we combine both the diagnostic plots and the test results that we obtained into significance plots. In these plots, one can visualize GCNT2 expression per gut condition, and observe the statistical difference in GCNT2 expression between gut conditions. 

*Significance levels*

| P-value  | Legend  |
|----------|---------|
| > 0.05   | Nothing |
| ≤ 0.05   | *       |
| ≤ 0.01   | **      |
| ≤ 0.001  | ***     |
| ≤ 0.0001 | ****    |

```{r significance_plots_per_condition}
signif.plot(gcnt2.condition.expression, x = "Treatment", y = "GCNT2", 
            plot_type = "Scatter", test = "Wilcox",
            plot_title = "GCNT2 Expression vs. Gut Condition Omitting GCNT2 Non-expressing Cells, Wilcoxon Test")

signif.plot(gcnt2.condition.expression, x = "Treatment", y = "GCNT2", 
            plot_type = "Boxplot", test = "Tukey",
            plot_title = "GCNT2 Expression vs. Gut Condition Omitting GCNT2 Non-expressing Cells, Tukey Test")
```

# Analysis per Cell Type per Gut Condition

In this section, we iterate over each cell type and subdivide into distinct gut conditions. This way, we will analyze GCNT2 expression per cell type per gut condition.

```{r setting_idents}
Seurat::Idents(filtered_cmc) <- "manual_annotation"

cell_types <- unique(Seurat::Idents(filtered_cmc))
conditions <- unique(filtered_cmc$Treatment)
```

## Heatmap

```{r dot_plot}
gcnt2.cell.condition <- Seurat::FetchData(filtered_cmc, vars = c("GCNT2", "manual_annotation", "Treatment"))

gcnt2.cell.condition %>% 
  dplyr::group_by(manual_annotation, Treatment) %>% 
  summarise(mean_GCNT2 = mean(GCNT2), .groups = "drop") -> mean.gcnt2.df 
  # tidyr::pivot_wider(names_from = Treatment, values_from = mean_GCNT2) %>% 
  # tibble::column_to_rownames(var = "manual_annotation") -> mean.gcnt2.df 

ggplot2::ggplot(mean.gcnt2.df, ggplot2::aes(x = Treatment, y = manual_annotation, fill = mean_GCNT2)) +
  ggplot2::geom_tile()
```


## Anova Tables

```{r anova_tables}
for(cell_type in cell_types){
  cell_type_meta <- subset(filtered_cmc, idents = cell_type)@meta.data
  condition_frequency <- table(cell_type_meta$Treatment) 
  
  un_rep_conditions <- names(condition_frequency)[condition_frequency <= 1]
  
  if(length(un_rep_conditions) < length(unique(cell_type_meta$Treatment))) {
    cell_type_meta <- subset(cell_type_meta, subset = !(Treatment %in% un_rep_conditions))
    gcnt2.aov.model <- aov(cell_type_meta$GCNT2 ~ cell_type_meta$Treatment)
    cat(sprintf("\033[31m%s Cells\033[39m\n", cell_type))
    print(summary(gcnt2.aov.model))
    cat("\n")
  }
}
```


## Ridge Plots

```{r ridge_plots}
for(cell_type in cell_types){
  
  cell_type_seurat <- subset(filtered_cmc, idents = cell_type)
  condition_frequency <- table(cell_type_seurat$Treatment) 
  
  un_rep_conditions <- names(condition_frequency)[condition_frequency <= 1]
  
  if (length(un_rep_conditions) < length(unique(cell_type_seurat$Treatment))){
    cell_type_seurat <- subset(cell_type_seurat, subset = !(Treatment %in% un_rep_conditions)) 
    
    print(Seurat::RidgePlot(cell_type_seurat, features = "GCNT2", group.by = "Treatment") + 
        ggplot2::ggtitle(sprintf("%s Cells", cell_type)))
  }
}
```

## Volcano Plots



## Significance Plots

```{r significance_plots}
for(cell_type in cell_types){
  cell_type_meta <- subset(filtered_cmc, idents = cell_type)@meta.data
  condition_frequency <- table(cell_type_meta$Treatment) 
  
  un_rep_conditions <- names(condition_frequency)[condition_frequency <= 1]
  
  if(length(un_rep_conditions) < length(unique(cell_type_meta$Treatment))) {
    cell_type_meta <- subset(cell_type_meta, subset = !(Treatment %in% un_rep_conditions))
    print(signif.plot(cell_type_meta, x = "Treatment", y = "GCNT2", plot_type = "Boxplot",
                      test = "T-test", plot_title = sprintf("%s Cells", cell_type)))
  }
}
```







